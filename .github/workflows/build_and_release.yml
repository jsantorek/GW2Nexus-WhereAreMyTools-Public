name: Conan Build & Release

on:
  release:
    types: [created]

permissions:
  contents: write

env:
  SUBMODULE_PATH: GW2-WhereAreMyTools
  CONAN_HOME: /root/.conan2

jobs:
  build:
    if: github.event.release.draft == true && startsWith(github.event.release.tag_name, 'v')
    runs-on: ubuntu-latest
    container: ghcr.io/jsantorek/gw2-addon-builder:latest
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v6
        with:
          submodule: recursive
          token: ${{ secrets.SOURCE_REPO_TOKEN }}
          ref: main
          fetch-depth: 0

      - name: Conan install dependencies
        run: >
          conan install ${{ env.SUBMODULE_PATH }}
          --build missing
          --profile:host windows-dynamic
          --profile:build default
      
      - name: Conan build addon
        run: >
          conan build ${{ env.SUBMODULE_PATH }}
          --profile:host windows-dynamic
          --profile:build default
          --conf tools.cmake.cmaketoolchain:extra_variables*='{
          "ADDON_UPDATE_LINK": "${{ github.server_url }}/${{ github.repository }}",
          "ADDON_VERSION": "${{ github.ref_name}}"
          }'

      - name: Upload binaries to the release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_id: ${{ github.event.release.id }}
          files: build/**/*.dll
          fail_on_unmatched_files: true

      - name: Publish the release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          make_latest: true
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, '-rc') }}
          tag_name: ${{ github.ref_name}}
